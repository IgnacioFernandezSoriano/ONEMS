name: Supabase Keep-Alive

# This workflow prevents Supabase free tier from auto-pausing due to inactivity
# It runs every 6 days and makes a simple query to keep the database active

on:
  # Schedule: Run every 6 days at midnight UTC
  schedule:
    - cron: '0 0 */6 * *'
  
  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:

jobs:
  ping-supabase:
    runs-on: ubuntu-latest
    
    steps:
      - name: Ping Supabase Database
        run: |
          echo "üîÑ Pinging Supabase to keep database active..."
          
          # Make a simple query to the accounts table
          # This keeps the database active and prevents auto-pause
          response=$(curl -s -w "\n%{http_code}" -X GET \
            "https://sehbnpgzqljrsqimwyuz.supabase.co/rest/v1/accounts?select=id&limit=1" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json")
          
          # Extract HTTP status code
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "üìä Response Status: $http_code"
          
          # Check if request was successful
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 206 ]; then
            echo "‚úÖ Supabase database is active and responding"
            echo "üìÖ Last ping: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          else
            echo "‚ùå Failed to ping Supabase (HTTP $http_code)"
            echo "Response: $body"
            exit 1
          fi
      
      - name: Log Success
        if: success()
        run: |
          echo "üéâ Keep-alive ping successful!"
          echo "‚è∞ Next scheduled run: $(date -u -d '+6 days' '+%Y-%m-%d %H:%M:%S UTC')"
      
      - name: Log Failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è Keep-alive ping failed!"
          echo "Please check:"
          echo "  1. SUPABASE_ANON_KEY secret is set correctly"
          echo "  2. Supabase project is not paused manually"
          echo "  3. Supabase project URL is correct"
